<!DOCTYPE html>
<html lang="en">
<head>
                                                                                                   <!-- importing bootstrap && other stuffs -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="shortcut icon" href="https://www.rutgers.edu/sites/all/themes/uwide/favicon.ico" type="image/vnd.microsoft.icon">
  <!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9FCsoZWld-8JgJwwz6H4GvM-JtYBDSfY&libraries=places"></script>-->

  <div style="font-weight: bold;">
    <title>
      Rutgers ClassMapper
    </title>
  </div>


    <title>Index</title>
    <style>
        .btn-dark{
          background-color: gray;
        }
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
          height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
    </style>



</head>



<div class="p-4 mb-0 bg-danger text-white font-weight-bold clearfix">
  <div style="width: 3.5%; height: 3.5%; float: left; object-fit: contain;">
    <center>
      <img src=ruShield2.png style='height: 100%; width: 100%; object-fit: contain;'/>
    </center>
  </div>
  <h2 style="margin-left: 5%; margin-top: 0.5%">
    Rutgers ClassMapper
  </h2>
</div>   <!-- Top div. -->
<div class="p-0 mb-0 bg-dark"></div>                                                                  <!-- stylistic stuff -->
<div class="p-2 mb-1 bg-dark"></div>                                                                  <!-- stylistic stuff -->
<div class="p-5 mb-2 text-white" style="height: 100%; margin-top: -1%">                                     <!-- File input Div -->
  <body>     <!-- disable scrolling -->
    <!--
    <center>
      <span class="border border-dark rounded">
        <p class="text-light d-inline p-4 bg-red text-dark">Upload your schedule (.ics file) here:</p>
      </span>
        <p><br></p>
    </center>
    -->
  <div id='leftDiv' style='width:30%; float:left;'>    <!-- Master left side div -->
    <!--<input type="text" id='addressSearch'class="form-control" placeholder="Address" aria-label="Address">-->

    <div id = "textUploadAndDropdown" style="width: 100%; padding-left: 0px;padding-right:20px">

      <div class="btn-group" style = "float: left; width: 39%">

        <select id='campusDropdown' class="browser-default custom-select">
          <option selected>Campus</option>
          <option value="BUS">Busch</option>
          <option value="CAC">College Ave</option>
          <option value="LIV">Livingston</option>
          <option value="C/D">Cook/Douglass</option>
        </select>
      </div>

      <div id = "uploadAddress" style="padding-left: 1px; float: right; width: 61%">
          <center>
            <input type="text" id='addressSearch'class="form-control" placeholder="Dorm address" aria-label="Dorm address" style="float:left; width: 100%; margin-bottom: 2%;">

          </center>
      </div>

    </div>

    <div id = "buttonDivMain" style="float: left; width: 100%; height: 75px" class="clearfix">  <!-- Fits both submit and upload buttons in one div, has border and clearfix  -->

      <div id = "uploadButtonDiv" style="width: auto; padding-left: 0px; float: left;" >                              <!-- Upload button floated left -->

          <div class='new_Btn' style="width: 100%;">
            <button class = "btn btn-dark" type ="button">Upload your schedule (.ics file) here!</button>
          </div>
          <input class="btn btn-primary" type='file' id='chatFileOpen' name='ics file' accept='.ics' style="display:none"> <!-- FILE INPUT -->
          <a href="https://eas.rutgers.edu/?ht_kb=import-course-schedule-to-google-calendar" style="font-size: 10px; float: left;">Learn how to export your schedule</a>

      </div>

      <div id="greenChecker" style='height: 25px; width: 25px; float: left; padding-left: 0; padding-right: 0; padding-top: 0px;padding-bottom: 0px;margin-left: 2.5%; margin-right: 2.5%'>    <!-- div that holds the green check mark -->
        <center>
          <img src=greenTick.png style='height: 100%; width: 100%; object-fit: contain;'/>
        </center>
      </div>

      <div id = "submitButtonDiv" style="width: 22%; padding-right: 20px; float: right">               <!-- Submit button floated left to border upload button -->
        <button id = "submitButtonBUTTON" onclick='upload()' type="button" class="btn btn-primary btn-success btn-block border border-dark rounded"> Submit! </button>  <!-- submit button. INITIALIZED IN JS BELOW -->
      </div>

    </div>
    <div id = 'loading' style='display:none'>
      <center><img src='loading.gif'></center>
    </div>
    <div id='schedule' style='display:none;float:left;width:100%;padding-right:15px;padding-top:0px'>

        <style>
          table, th, td {
            border: 1.5px solid black;
            border-collapse: collapse;
          }
          th, td {
            padding: 5px;
            color: black;
          }
          th {
            text-align: center;
          }
        </style>

        <table id='table' style="width:100%">
          <tr>
            <th>Day</th>
            <th>Classes</th>

          </tr>
          <tr>
            <td id = "dayOnTable"></td>
            <td id = "monDesc">Nothing!</td>

          </tr>
        </table>

    </div>
  </div>
<style>
.tab {
  color: white;
  float:left;
  background-color: gray;
  text-align: center;
  width:19.8%;
  margin:.1%;
  cursor: pointer;
}
</style>


    <div style='float:right;width:70%;height:100%'>
      <div id='tabs'style="height:5%">
        <div onclick='mon()' id='mon'class='tab' >Monday</div>
        <div onclick='tue()' id='tue'class='tab' >Tuesday</div>
        <div onclick='wed()' id='wed'class='tab' >Wednesday</div>
        <div onclick='thu()' id='thu'class='tab' >Thursday</div>
        <div onclick='fri()' id='fri'class='tab' >Friday</div>



      </div>
    <div id = "map" style="" class="clearfix">  <!-- div for the map -->
      <script>
        var map;
          function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 40.504746, lng: -74.451802}, //40.504746, -74.451802
              zoom: 14
              });
            var line = "y~ivFtzmeMZaAf@wAcDmFM]EMMMh@gCd@mC@SA}@s@_Im@eHO{AMaB@]Ae@@k@LaA`A}E~@cE|A{HrAkGf@_DpAeK\\_Bd@cB`@}@\\YP?JEHMDQ?Q?GVoB`BsDpC}FBIc@c@w@u@YWKAcAaAgAeAE@OVIWCCSO?IfAaCo@k@}@u@EKAKVeANDP?LITa@F";

            }

            // Script to hide submit button:
            //document.getElementById("submitButtonDiv").style.disabled;

        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9FCsoZWld-8JgJwwz6H4GvM-JtYBDSfY&callback=initMap"
        async defer></script>

    </div>
  </div>
  </body>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script>
var socket = io.connect('http://127.0.0.1:4000');
function gray(){

  var children = document.getElementById('tabs').children;
  for (var i = 0; i < children.length; i++) {
  var child = children[i];
  child.style.backgroundColor='gray';
  // Do stuff
}
}
mon();
function mon(){
  gray();
  document.getElementById('mon').style.backgroundColor='black';
  document.getElementById("dayOnTable").innerHTML = "Monday";
  document.getElementById("monDesc").innerHTML = monAgenda;
  socket.emit('getDayRouteSocket',"Monday");
}
function tue(){
  gray();
  document.getElementById('tue').style.backgroundColor='black';
  document.getElementById("dayOnTable").innerHTML = "Tuesday";
  document.getElementById("monDesc").innerHTML = tueAgenda;
  socket.emit('getDayRouteSocket',"Tuesday");
}
function wed(){
  gray();
  document.getElementById('wed').style.backgroundColor='black';
  document.getElementById("dayOnTable").innerHTML = "Wednesday";
  document.getElementById("monDesc").innerHTML = wedAgenda;
  socket.emit('getDayRouteSocket',"Wednesday");
}
function thu(){
  gray();
  document.getElementById('thu').style.backgroundColor='black';
  document.getElementById("dayOnTable").innerHTML = "Thursday";
  document.getElementById("monDesc").innerHTML = thuAgenda;
  socket.emit('getDayRouteSocket',"Thursday");
}
function fri(){
  gray();
  document.getElementById('fri').style.backgroundColor='black';
  document.getElementById("dayOnTable").innerHTML = "Friday";
  document.getElementById("monDesc").innerHTML = friAgenda;
  socket.emit('getDayRouteSocket',"Friday");
}

document.getElementById("submitButtonBUTTON").disabled = true;  // initialize button to diabled
document.getElementById("greenChecker").style.opacity = '0.0'; // initialize green check to 'hidden' state

var input = document.getElementById('chatFileOpen');
input.addEventListener('change', updateSubmitButton);  // looks for change in upload value of upload button

function updateSubmitButton(){

  // function to reenale submit button after someone actually uploads file onto cache.
  document.getElementById("submitButtonBUTTON").disabled = false;
  document.getElementById("greenChecker").style.opacity = '1.0';
}

$('.new_Btn').on("click" , function () {
    $('#chatFileOpen').click();
});

line1 = null;

function upload(){
  document.getElementById('submitButtonBUTTON').disabled = true;
  document.getElementById('loading').style.display='inline';
  var length = input.files.length;
  campus = document.getElementById('campusDropdown').value;
  addressInput=document.getElementById('addressSearch').value;
  home_address = addressInput+"\n"+campus //TODO fix this
  input.files.item(0).text().then(text => socket.emit('upload',{file:text, home:home_address}));

}

socket.on("polyline",function(data){
  initMap();
  document.getElementById('submitButtonBUTTON').disabled = false;
  document.getElementById('loading').style.display='none';
  line1 = new google.maps.Polyline({
    path: data.line,
    strokeColor: '#FF0000',
	  strokeOpacity: 1.0,
	  strokeWeight: 2
  });


  var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  for(i = 0; i < data.destinations.length; i++) {
    // if(data.destinations[i] == null){
    //   continue
    // }
    //
    // let label_index = []
    //
    // console.log(data.destinations.slice(i+1,data.destinations.length))
    //
    // function check_in_dest(dest, list) {
    //     for(k = 0; k < list.length; k++) {
    //       if(list[k] != null && dest.address == list[k].address) {
    //         return k
    //       }
    //     }
    //     return false;
    // }
    //
    // in_dest = check_in_dest(data.destinations[i], data.destinations.slice(i+1,data.destinations.length))
    //
    // if(in_dest) {
    //     sum = (parseInt(in_dest) + parseInt(i))
    //   label_index.push(parseInt(in_dest) + parseInt(i))
    //   data.destinations[sum] = null;
    //   in_dest = check_in_dest(data.destinations[i], data.destinations.slice(in_dest+1,data.destinations.length))
    //   console.log(label_index)
    // }
    //
    // let label = "" + labels[i]
    //
    // for(j in label_index) {
    //   label += ",           " + labels[label_index[j]]
    // }

    let marker = new google.maps.Marker({
      position: data.destinations[i]["location"],
      title: data.destinations[i]["address"],
      map: map,
      // label: label,
      clickable: true
    });

    let content = "<p style='color:black'>"+data.destinations[i]['address']+"</p>";
    let infoWindow = new google.maps.InfoWindow({
      position: marker.getPosition(),
      content: content
    });

    marker.addListener('click', function() {
       infoWindow.open(map, marker)
    })
  }


  line1.setMap(map);
  //map.addOverlay(line1);
  //map.addPolyline(line1);
});

var monAgenda;
var tueAgenda;
var wedAgenda;
var thuAgenda;
var friAgenda;

socket.on("textSchedule",function(class_details){
  // console.log(class_details);
  // calls tableOrganizer function and passes 5 parameters. each param is an array of the respective day.
  console.log(class_details);
  //tableOrganizer(class_details["Monday"], class_details["Tuesday"], class_details["Wednesday"], class_details["Thursday"], class_details["Friday"]);
  monAgenda = updateTable(class_details["Monday"])
  tueAgenda = updateTable(class_details["Tuesday"])
  wedAgenda = updateTable(class_details["Wednesday"])
  thuAgenda = updateTable(class_details["Thursday"])
  friAgenda = updateTable(class_details["Friday"])

  mon()
});

//script to put all classes under their respective day's table row.
//5 arrays, traverses each array.


function updateTable(arr) {
  document.getElementById('schedule').style.display='inline';
  agenda = ""
  for(i = 0; i < arr.length; i++){
    if(arr[i]["message"]){
      agenda += JSON.stringify(arr[i]["message"])
      agenda = agenda.replace(/\"/g, "");
      agenda = agenda.replace(/ Bus Stop Rutgers/g, " stop.")
    }
    else if(!arr[i].acronym) {
      continue;
    }
    else {
      agenda += JSON.stringify(arr[i].name)+" at "+JSON.stringify(arr[i].acronym)+" ("+JSON.stringify(arr[i].loc_name)+")"+" starting at "+JSON.stringify(arr[i].startTime)+" and ending at "+JSON.stringify(arr[i].endTime)+".<br><br>";

      agenda = agenda.replace(/\"/g, "");
      agenda = agenda.replace(/Rutgers/g, "")
    }
    //classElement = monArray[i];
    //agenda = agenda + JSON.stringify(classElement) + "<br>";
  }
  return agenda

}


// function tableOrganizer(monArray, tueArray, wedArray, thuArray, friArray){    // logic for parsing array for each day and putting in table
//
//   table = document.getElementById("table");
//   monAgenda="";
//   tueAgenda="";
//   wedAgenda="";
//   thuAgenda="";
//   friAgenda="";
//
//
//   //var s = "monArray";
//   //
//
//   for(i = 0; i < monArray.length; i++){
//     if(monArray[i]["message"]){
//       monAgenda = JSON.stringify(monArray[i]["message"])
//     }
//     else if(!monArray[i].acronym) {
//       continue;
//     }
//     else {
//       monAgenda = monAgenda + JSON.stringify(monArray[i].name)+" at "+JSON.stringify(monArray[i].acronym)+" ("+JSON.stringify(monArray[i].loc_name)+")"+" starting at "+JSON.stringify(monArray[i].startTime)+" and ending at "+JSON.stringify(monArray[i].endTime)+"<br>"+"<br>";
//
//       monAgenda = monAgenda.replace(/"/g, "");
//     }
//     //classElement = monArray[i];
//     //agenda = agenda + JSON.stringify(classElement) + "<br>";
//   }
//   document.getElementById('schedule').style.display='inline';
//   document.getElementById("monDesc").innerHTML = monAgenda;
//   document.getElementById("dayOnTable").textContent = "Monday";
//
//   //monAgenda = "";
//
//   for(i = 0; i < tueArray.length; i++){
//     tueAgenda = tueAgenda + JSON.stringify(tueArray[i].name)+" at "+JSON.stringify(tueArray[i].acronym)+" ("+JSON.stringify(tueArray[i].loc_name)+")"+" starting at "+JSON.stringify(tueArray[i].startTime)+" and ending at "+JSON.stringify(tueArray[i].endTime)+"<br>"+"<br>";
//
//     tueAgenda = tueAgenda.replace(/"/g, "");
//   }
//
//   //document.getElementById("tueDesc").textContent = tueAgenda;
//
//   //tueAgenda = "";
//
//   for(i = 0; i < wedArray.length; i++){
//     wedAgenda = wedAgenda + JSON.stringify(wedArray[i].name)+" at "+JSON.stringify(wedArray[i].acronym)+" ("+JSON.stringify(wedArray[i].loc_name)+")"+" starting at "+JSON.stringify(wedArray[i].startTime)+" and ending at "+JSON.stringify(wedArray[i].endTime)+"<br>"+"<br>";
//
//     wedAgenda = wedAgenda.replace(/"/g, "");
//   }
//
//   //document.getElementById("wedDesc").textContent = wedAgenda;
//   //wedAgenda = "";
//
//   for(i = 0; i < thuArray.length; i++){
//     thuAgenda = thuAgenda + JSON.stringify(thuArray[i].name)+" at "+JSON.stringify(thuArray[i].acronym)+" ("+JSON.stringify(thuArray[i].loc_name)+")"+" starting at "+JSON.stringify(thuArray[i].startTime)+" and ending at "+JSON.stringify(thuArray[i].endTime)+"<br>"+"<br>";
//
//     thuAgenda = thuAgenda.replace(/"/g, "");
//   }
//   //document.getElementById("thuDesc").textContent = thuAgenda;
//   //thuAgenda = "";
//
//   for(i = 0; i < friArray.length; i++){
//     friAgenda = friAgenda + JSON.stringify(friArray[i].name)+" at "+JSON.stringify(friArray[i].acronym)+" ("+JSON.stringify(friArray[i].loc_name)+")"+" starting at "+JSON.stringify(friArray[i].startTime)+" and ending at "+JSON.stringify(friArray[i].endTime)+"<br>"+"<br>";
//
//     friAgenda = friAgenda.replace(/"/g, "");
//   }
//   //document.getElementById("friDesc").textContent = friAgenda;
//   //friAgenda = "";
//
// }

/*var textInput = document.getElementById('addressSearch');
var autocomplete = new google.maps.places.Autocomplete(textInput);*/

</script>
</html>
